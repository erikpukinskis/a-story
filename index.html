<html>


<!-- LAYOUT -->

<body>
  <div class="two-columns">
    <div class="column">
      <div class="output"></div>
    </div>
    <div class="column">
      <div id="program-header"></div>
      <div class="program"></div>
    </div>
  </div>
</body>



<!-- EDITOR DEPENDENCIES -->

<script src="../build/he.js"></script>
<script src="../build/element.js"></script>
<script src="../build/tree.js"></script>
<script src="../build/library.js"></script>
<script src="../build/function-call.js"></script>
<script src="../build/add-html.js"></script>
<script src="../build/make-it-editable.js"></script>
<script src="../build/tap-out.js"></script>
<script src="menu.js"></script>
<script src="an-expression.js"></script>
<script src="draw-expression.js"></script>






<!-- APP DEPENDENCIES -->

<script>


  var library = new Library()
  var using = library.using.bind(library)

</script>

<script src="../build/bridge-to.library.js"></script>

<script src="../build/draw-scene.library.js"></script>

<script src="../build/add-html.library.js"></script>

<script src="../build/element.library.js"></script>



<!-- DATA -->

<!-- <script src="load-empty-program.js"></script> -->
<script src="load-sample-home-page.js"></script>
<!-- <script src="load-scene.js"></script> -->



<!-- STARTUP -->

<script type="text/javascript">

  var programName = loadedProgram.name || "unnamed"

  function getName() {
    return programName
  }

  function setName(newName) {
    programName = newName
    programChanged()
  }

  var title = element(".program-name", programName)

  makeItEditable(title, getName, setName)

  var header = document.getElementById("program-header")

  addHtml.inside(header, title.html())



  var el = drawExpression(
      loadedProgram)

  document.querySelector(".program").innerHTML = el.html()

  programChanged()




  // Change handlers

  function onNewExpression(parentExpression, newExpression) {
    updateDependencies(parentExpression, newExpression)
  }

  function programChanged() {
    window.__nrtvFocusSelector = ".output"

    document.querySelector(".output").innerHTML = ""

    var expression = packageAsModule(loadedProgram)

    anExpression.run(expression, programName)
  }




  function packageAsModule(functionLiteral) {
    
    return {
      kind: "function call",
      functionName: "using",
      arguments: [
        {
          kind: "array literal",
          items: argumentNamesToStringLiterals(functionLiteral)
        },
        functionLiteral
      ]
    }

  }

  function argumentNamesToStringLiterals(functionLiteral) {

    return functionLiteral
      .argumentNames
      .map(
        function(camelCase) {
          return anExpression.stringLiteral(
            dasherize(camelCase)
          )
        }
      )

  }

  function dasherize(camelCase) {
    var parts = camelCase.match(/([^A-Z]+)([A-Z][^A-Z])*/)

    var dashed
    for(var i=1; i<parts.length; i++) {
      if (!parts[i]) { continue }
      var part = parts[i].toLowerCase()
      if (dashed) {
        dashed = dashed+"-"+part
      } else {
        dashed = part
      }
    }
    return dashed
  }


  function updateDependencies(parent, line) {

    if (line.kind == "function call") {

      var deps = getDeps(line)

      var package = getPackageFunctionLiteral(parent)

      if (package && deps.length) {
        deps.forEach(function(dep) {
          var isMissing = package.argumentNames.indexOf(dep) == -1
          if (isMissing) {
            addDependency(package, dep)
          }
        })
      }
    }
  }

  function getDeps(newExpression) {
    var deps = []
    var lines = newExpression.body
    var name = newExpression.functionName

    if (name) {
      var parts = name.split(".")
      deps.push(parts[0])
    }

    if (lines) {
      for(var i=0; i<lines; i++) {
        var moreDeps =
          getDeps(lines[i])
        deps = deps.concat(modeDeps)
      }
    }

    return deps
  }


  function getPackageFunctionLiteral(expression) {
    if (expression.kind == "function literal") {
      return expression
    }
  }

  function addDependency(package, dep) {
    drawExpression.addFunctionArgument(package.id, dep)

    var scriptTag = element(
      "script",
      {
        src: "../build/"+dasherize(dep)+".library.js"
      }
    )

    addHtml(scriptTag.html())
  }


</script>


<!-- STYLES -->

<link rel="stylesheet" href="styles.css">


</html>
